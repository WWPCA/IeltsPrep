<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mobile Purchase Simulator - IELTS GenAI Prep</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .simulator-container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }

        .phone-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .phone-header h1 {
            color: #333;
            font-size: 24px;
            margin-bottom: 10px;
        }

        .phone-header p {
            color: #666;
            font-size: 14px;
        }

        .assessment-grid {
            display: grid;
            gap: 15px;
            margin-bottom: 30px;
        }

        .assessment-card {
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .assessment-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
        }

        .assessment-card.purchased {
            border-color: #28a745;
            background-color: #f8fff9;
        }

        .card-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 10px;
        }

        .card-title {
            font-weight: 600;
            color: #333;
            font-size: 16px;
            margin-bottom: 5px;
        }

        .card-description {
            color: #666;
            font-size: 14px;
            line-height: 1.4;
            margin-bottom: 15px;
        }

        .purchase-button {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .purchase-button.available {
            background: #667eea;
            color: white;
        }

        .purchase-button.available:hover {
            background: #5a6fd8;
        }

        .purchase-button.purchased {
            background: #28a745;
            color: white;
            cursor: default;
        }

        .purchase-button:disabled {
            background: #e9ecef;
            color: #6c757d;
            cursor: not-allowed;
        }

        .test-controls {
            border-top: 2px solid #e9ecef;
            padding-top: 20px;
            text-align: center;
        }

        .test-controls h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .test-button {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            margin: 5px;
            transition: all 0.3s ease;
        }

        .test-button:hover {
            background: #218838;
        }

        .test-button.secondary {
            background: #6c757d;
        }

        .test-button.secondary:hover {
            background: #545b62;
        }

        .status-message {
            margin-top: 15px;
            padding: 10px;
            border-radius: 8px;
            font-size: 14px;
            text-align: center;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .qr-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .qr-modal-content {
            background: white;
            border-radius: 16px;
            padding: 30px;
            max-width: 350px;
            width: 90%;
            text-align: center;
        }

        .qr-success-icon {
            font-size: 48px;
            color: #28a745;
            margin-bottom: 15px;
        }

        .qr-image {
            width: 200px;
            height: 200px;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            margin: 20px auto;
            display: block;
        }

        .qr-instructions {
            color: #666;
            font-size: 14px;
            margin: 15px 0;
            line-height: 1.5;
        }

        .qr-expiry {
            color: #dc3545;
            font-weight: 600;
            font-size: 12px;
            margin-bottom: 20px;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
        }

        .modal-button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }

        .modal-button.primary {
            background: #667eea;
            color: white;
        }

        .modal-button.secondary {
            background: #6c757d;
            color: white;
        }
    </style>
</head>
<body>
    <div class="simulator-container">
        <div class="phone-header">
            <h1>IELTS GenAI Prep</h1>
            <p>Mobile Purchase Simulator</p>
        </div>

        <div class="assessment-grid" id="assessmentGrid">
            <div class="assessment-card" data-product="academic_speaking_assessment">
                <div class="card-title">Academic Speaking Assessment</div>
                <div class="card-description">Practice with AI examiner Maya. Get detailed feedback on fluency, pronunciation, and vocabulary.</div>
                <button class="purchase-button available" onclick="simulatePurchase('academic_speaking_assessment')">
                    Purchase - $36.00
                </button>
            </div>

            <div class="assessment-card" data-product="academic_writing_assessment">
                <div class="card-title">Academic Writing Assessment</div>
                <div class="card-description">Tasks 1 & 2 with comprehensive AI evaluation. Detailed feedback on all assessment criteria.</div>
                <button class="purchase-button available" onclick="simulatePurchase('academic_writing_assessment')">
                    Purchase - $36.00
                </button>
            </div>

            <div class="assessment-card" data-product="general_speaking_assessment">
                <div class="card-title">General Speaking Assessment</div>
                <div class="card-description">Everyday conversation practice with AI examiner. Focus on practical communication skills.</div>
                <button class="purchase-button available" onclick="simulatePurchase('general_speaking_assessment')">
                    Purchase - $36.00
                </button>
            </div>

            <div class="assessment-card" data-product="general_writing_assessment">
                <div class="card-title">General Writing Assessment</div>
                <div class="card-description">Letter writing and essay composition. Expert feedback on task response and language use.</div>
                <button class="purchase-button available" onclick="simulatePurchase('general_writing_assessment')">
                    Purchase - $36.00
                </button>
            </div>
        </div>

        <div class="test-controls">
            <h3>Testing Controls</h3>
            <button class="test-button" onclick="openWebsite()">Open Website</button>
            <button class="test-button secondary" onclick="resetPurchases()">Reset All</button>
            <div id="statusMessage"></div>
        </div>
    </div>

    <!-- QR Code Modal -->
    <div class="qr-modal" id="qrModal">
        <div class="qr-modal-content">
            <div class="qr-success-icon">✓</div>
            <h2>Purchase Successful!</h2>
            <p id="purchaseProductName">Assessment purchased successfully</p>
            
            <h3 style="margin-top: 20px;">Access on Website</h3>
            <img id="qrCodeImage" class="qr-image" src="" alt="QR Code">
            
            <p class="qr-instructions">
                Scan this QR code on <strong>your .replit domain</strong> to access your assessment
            </p>
            <p class="qr-expiry" id="qrExpiry">Code expires in 10 minutes</p>
            
            <div class="modal-actions">
                <button class="modal-button primary" onclick="closeQRModal()">Continue in App</button>
                <button class="modal-button secondary" onclick="openWebsite()">Open Website</button>
            </div>
        </div>
    </div>

    <script>
        const purchasedProducts = new Set();
        
        const productNames = {
            'academic_speaking_assessment': 'Academic Speaking Assessment',
            'academic_writing_assessment': 'Academic Writing Assessment',
            'general_speaking_assessment': 'General Speaking Assessment',
            'general_writing_assessment': 'General Writing Assessment'
        };

        function simulatePurchase(productId) {
            if (purchasedProducts.has(productId)) {
                showToast('Product already purchased!', 'long', 'center');
                return;
            }

            // Simulate Capacitor purchase processing with realistic delays
            showToast('Connecting to App Store...', 'short', 'bottom');
            showStatus('Processing purchase...', 'info');
            
            // Phase 1: App Store connection (1 second)
            setTimeout(() => {
                showToast('Verifying payment...', 'short', 'bottom');
                
                // Phase 2: Payment verification (1.5 seconds)
                setTimeout(() => {
                    showToast('Purchase successful!', 'long', 'center');
                    
                    // Mark as purchased
                    purchasedProducts.add(productId);
                    updateProductUI(productId);
                    
                    // Generate QR code with enhanced data
                    generateQRCodeWithMockPurchase(productId);
                    
                    showStatus('Purchase completed successfully!', 'success');
                    
                    // Log to CloudWatch simulation
                    console.log(`[CLOUDWATCH] Mock purchase completed: ${productId} for test.user@example.com`);
                }, 1500);
            }, 1000);
        }

        function showToast(message, duration = 'short', position = 'bottom') {
            // Simulate Capacitor Toast plugin
            const toast = document.createElement('div');
            toast.className = 'capacitor-toast';
            toast.textContent = message;
            toast.style.cssText = `
                position: fixed;
                background: rgba(0,0,0,0.8);
                color: white;
                padding: 12px 20px;
                border-radius: 25px;
                font-size: 14px;
                z-index: 10000;
                max-width: 300px;
                text-align: center;
                ${position === 'top' ? 'top: 50px;' : position === 'center' ? 'top: 50%; transform: translateY(-50%);' : 'bottom: 100px;'}
                left: 50%;
                transform: translateX(-50%) ${position === 'center' ? 'translateY(-50%)' : ''};
            `;
            
            document.body.appendChild(toast);
            
            const displayTime = duration === 'long' ? 3500 : 2000;
            setTimeout(() => {
                if (toast.parentNode) toast.remove();
            }, displayTime);
        }

        function updateProductUI(productId) {
            const card = document.querySelector(`[data-product="${productId}"]`);
            const button = card.querySelector('.purchase-button');
            
            card.classList.add('purchased');
            button.classList.remove('available');
            button.classList.add('purchased');
            button.textContent = '✓ Purchased';
            button.disabled = true;
        }

        function generateQRCodeWithMockPurchase(productId) {
            // Generate UUID for mock purchase token
            const mockToken = 'mock_' + generateUUID();
            
            // Simulate Capacitor in-app purchase receipt data
            const mockReceiptData = {
                transaction_id: mockToken,
                product_id: productId,
                purchase_date: new Date().toISOString(),
                receipt_data: btoa(JSON.stringify({
                    product_id: productId,
                    transaction_id: mockToken,
                    purchase_token: mockToken
                }))
            };
            
            console.log(`[CLOUDWATCH] Generating QR for mock purchase: ${JSON.stringify(mockReceiptData)}`);
            
            // Call Lambda endpoint with mock purchase verification
            fetch('/api/auth/generate-qr', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    user_email: 'test.user@example.com',
                    product_id: productId,
                    purchase_verified: true,
                    receipt_data: mockReceiptData.receipt_data,
                    transaction_id: mockToken
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showQRModal(productId, data.qr_code_image, data.expires_at);
                    showToast('QR code ready for website scan', 'long', 'center');
                } else {
                    showStatus('Failed to generate QR code: ' + data.error, 'error');
                    showToast('QR generation failed', 'short', 'center');
                }
            })
            .catch(error => {
                console.error('QR generation failed:', error);
                showStatus('Failed to generate QR code', 'error');
                showToast('Network error during QR generation', 'long', 'center');
            });
        }

        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        function showQRModal(productId, qrCodeImage, expiresAt) {
            const modal = document.getElementById('qrModal');
            const productNameEl = document.getElementById('purchaseProductName');
            const qrImageEl = document.getElementById('qrCodeImage');
            const expiryEl = document.getElementById('qrExpiry');
            
            productNameEl.textContent = productNames[productId] + ' purchased successfully';
            qrImageEl.src = qrCodeImage;
            
            // Calculate expiry time
            const expiryTime = new Date(expiresAt);
            const now = new Date();
            const minutesLeft = Math.max(0, Math.floor((expiryTime - now) / 60000));
            expiryEl.textContent = `Code expires in ${minutesLeft} minutes`;
            
            modal.style.display = 'flex';
            
            // Start countdown
            startExpiryCountdown(expiresAt);
        }

        function startExpiryCountdown(expiresAt) {
            const expiryEl = document.getElementById('qrExpiry');
            
            const updateCountdown = () => {
                const expiryTime = new Date(expiresAt);
                const now = new Date();
                const minutesLeft = Math.max(0, Math.floor((expiryTime - now) / 60000));
                const secondsLeft = Math.max(0, Math.floor(((expiryTime - now) % 60000) / 1000));
                
                if (minutesLeft > 0 || secondsLeft > 0) {
                    expiryEl.textContent = `Code expires in ${minutesLeft}:${secondsLeft.toString().padStart(2, '0')}`;
                } else {
                    expiryEl.textContent = 'QR code has expired';
                    expiryEl.style.color = '#dc3545';
                }
            };
            
            const countdownInterval = setInterval(updateCountdown, 1000);
            
            // Clear interval when modal is closed
            const modal = document.getElementById('qrModal');
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    clearInterval(countdownInterval);
                }
            });
        }

        function closeQRModal() {
            document.getElementById('qrModal').style.display = 'none';
        }

        function openWebsite() {
            const currentDomain = window.location.origin;
            window.open(`${currentDomain}/`, '_blank');
        }

        function resetPurchases() {
            purchasedProducts.clear();
            
            // Reset all product UIs
            document.querySelectorAll('.assessment-card').forEach(card => {
                card.classList.remove('purchased');
                const button = card.querySelector('.purchase-button');
                button.classList.remove('purchased');
                button.classList.add('available');
                button.disabled = false;
                button.textContent = 'Purchase - $36.00';
            });
            
            showStatus('All purchases reset', 'info');
        }

        function showStatus(message, type) {
            const statusEl = document.getElementById('statusMessage');
            statusEl.textContent = message;
            statusEl.className = `status-message status-${type}`;
            
            // Clear status after 5 seconds
            setTimeout(() => {
                statusEl.textContent = '';
                statusEl.className = '';
            }, 5000);
        }

        // Close modal when clicking outside
        document.getElementById('qrModal').addEventListener('click', (e) => {
            if (e.target.id === 'qrModal') {
                closeQRModal();
            }
        });
    </script>
</body>
</html>